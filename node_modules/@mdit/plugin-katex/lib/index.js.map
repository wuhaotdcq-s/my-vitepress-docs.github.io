{"version":3,"file":"index.js","sources":["../src/plugin.ts"],"sourcesContent":["import { escapeHtml } from \"@mdit/helper\";\nimport { tex } from \"@mdit/plugin-tex\";\nimport type { KatexOptions, KatexOptions as OriginalKatexOptions } from \"katex\";\nimport { ParseError, renderToString } from \"katex\";\nimport type MarkdownIt from \"markdown-it\";\n\nimport type { MarkdownItKatexOptions, TeXTransformer } from \"./options.js\";\n\nconst katexInline = (\n  tex: string,\n  options: OriginalKatexOptions,\n  transformer?: TeXTransformer,\n): string => {\n  let result: string;\n\n  try {\n    result = renderToString(tex, {\n      ...options,\n      displayMode: false,\n    });\n  } catch (error) {\n    /* istanbul ignore else -- @preserve */\n    if (error instanceof ParseError) {\n      console.error(error);\n      result = `<span class='katex-error' title='${escapeHtml(\n        (error as Error).toString(),\n      )}'>${escapeHtml(tex)}</span>`;\n    } else {\n      throw error;\n    }\n  }\n\n  return transformer?.(result, false) ?? result;\n};\n\nconst katexBlock = (\n  tex: string,\n  options: OriginalKatexOptions,\n  transformer?: TeXTransformer,\n): string => {\n  let result: string;\n\n  try {\n    result = `<p class='katex-block'>${renderToString(tex, {\n      ...options,\n      displayMode: true,\n    })}</p>\\n`;\n  } catch (error) {\n    /* istanbul ignore else -- @preserve */\n    if (error instanceof ParseError) {\n      console.error(error);\n      result = `<p class='katex-block katex-error' title='${escapeHtml(\n        (error as Error).toString(),\n      )}'>${escapeHtml(tex)}</p>\\n`;\n    } else {\n      throw error;\n    }\n  }\n\n  return transformer?.(result, true) ?? result;\n};\n\nexport const loadMhchem = async (): Promise<void> => {\n  await import(\"katex/contrib/mhchem\");\n};\n\nexport const katex = <MarkdownItEnv = unknown>(\n  md: MarkdownIt,\n  options: MarkdownItKatexOptions<MarkdownItEnv> = {},\n): void => {\n  const {\n    allowInlineWithSpace = false,\n    delimiters,\n    mathFence,\n    logger = (\n      errorCode: string,\n    ): \"ignore\" | \"warn\" | \"error\" | boolean | undefined =>\n      errorCode === \"newLineInDisplayMode\" ? \"ignore\" : \"warn\",\n    // see https://github.com/vuepress/ecosystem/issues/261\n    // this ensures that `\\gdef` works as expected\n    macros = {},\n    transformer,\n    ...userOptions\n  } = options;\n\n  md.use(tex, {\n    allowInlineWithSpace,\n    delimiters,\n    mathFence,\n    render: (content: string, displayMode: boolean, env: MarkdownItEnv) => {\n      const katexOptions: KatexOptions = {\n        strict: (errorCode, errorMsg, token) =>\n          logger(errorCode, errorMsg, token, env) ?? \"ignore\",\n        macros,\n        throwOnError: false,\n        ...userOptions,\n      };\n\n      return displayMode\n        ? katexBlock(content, katexOptions, transformer)\n        : katexInline(content, katexOptions, transformer);\n    },\n  });\n};\n"],"names":["katexInline","tex","options","transformer","result","renderToString","error","ParseError","escapeHtml","katexBlock","loadMhchem","katex","md","allowInlineWithSpace","delimiters","mathFence","logger","errorCode","macros","userOptions","content","displayMode","env","katexOptions","errorMsg","token"],"mappings":"wIAQA,MAAMA,EAAc,CAClBC,EACAC,EACAC,IACW,CACX,IAAIC,EAEJ,GAAI,CACFA,EAASC,EAAeJ,EAAK,CAC3B,GAAGC,EACH,YAAa,EACf,CAAC,CACH,OAASI,EAAO,CAAA,uCAEd,GAAIA,aAAiBC,EACnB,QAAQ,MAAMD,CAAK,EACnBF,EAAS,oCAAoCI,EAC1CF,EAAgB,SACnB,CAAA,CAAC,KAAKE,EAAWP,CAAG,CAAC,qBAEfK,CAEV,CAEA,OAAOH,IAAcC,EAAQ,EAAK,GAAKA,CACzC,EAEMK,EAAa,CACjBR,EACAC,EACAC,IACW,CACX,IAAIC,EAEJ,GAAI,CACFA,EAAS,0BAA0BC,EAAeJ,EAAK,CACrD,GAAGC,EACH,YAAa,EACf,CAAC,CAAC;AAAA,CACJ,OAASI,EAAO,CAAA,uCAEd,GAAIA,aAAiBC,EACnB,QAAQ,MAAMD,CAAK,EACnBF,EAAS,6CAA6CI,EACnDF,EAAgB,SAAA,CACnB,CAAC,KAAKE,EAAWP,CAAG,CAAC;AAAA,MAErB,OAAMK,CAEV,CAEA,OAAOH,IAAcC,EAAQ,EAAI,GAAKA,CACxC,EAEaM,EAAa,SAA2B,CACnD,KAAM,QAAO,sBAAsB,CACrC,EAEaC,EAAQ,CACnBC,EACAV,EAAiD,CAAC,IACzC,CACT,KAAM,CACJ,qBAAAW,EAAuB,GACvB,WAAAC,EACA,UAAAC,EACA,OAAAC,EACEC,GAEAA,IAAc,uBAAyB,SAAW,OAGpD,OAAAC,EAAS,CAAA,EACT,YAAAf,EACA,GAAGgB,CACL,EAAIjB,EAEJU,EAAG,IAAIX,EAAK,CACV,qBAAAY,EACA,WAAAC,EACA,UAAAC,EACA,OAAQ,CAACK,EAAiBC,EAAsBC,IAAuB,CACrE,MAAMC,EAA6B,CACjC,OAAQ,CAACN,EAAWO,EAAUC,IAC5BT,EAAOC,EAAWO,EAAUC,EAAOH,CAAG,GAAK,SAC7C,OAAAJ,EACA,aAAc,GACd,GAAGC,CACL,EAEA,OAAOE,EACHZ,EAAWW,EAASG,EAAcpB,CAAW,EAC7CH,EAAYoB,EAASG,EAAcpB,CAAW,CACpD,CACF,CAAC,CACH"}